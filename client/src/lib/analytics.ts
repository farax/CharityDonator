// New Relic browser agent utilities for tracking user actions
// This assumes the New Relic Browser script has been added to the HTML

type EventAttributes = Record<string, string | number | boolean>;

interface AnalyticsEvent {
  category: string;
  action: string;
  label?: string;
  value?: number;
  attributes?: EventAttributes;
}

/**
 * Track a user interaction event
 */
export function trackEvent({
  category,
  action,
  label,
  value,
  attributes = {},
}: AnalyticsEvent): void {
  // Only track events if New Relic is available
  if (typeof window !== 'undefined' && (window as any).newrelic) {
    const nr = (window as any).newrelic;
    
    // Format event name
    const eventName = `${category}:${action}`;
    
    // Prepare event attributes
    const eventAttributes: EventAttributes = {
      ...attributes,
    };
    
    // Add optional parameters if provided
    if (label) eventAttributes.label = label;
    if (value !== undefined) eventAttributes.value = value;
    
    // Add page information
    eventAttributes.page_url = window.location.href;
    eventAttributes.page_path = window.location.pathname;
    
    // Track the event in New Relic
    nr.addPageAction(eventName, eventAttributes);
    
    // Log in development for debugging
    if (process.env.NODE_ENV === 'development') {
      console.log('Analytics Event:', eventName, eventAttributes);
    }
  }
}

/**
 * Track page view
 */
export function trackPageView(path?: string): void {
  if (typeof window !== 'undefined' && (window as any).newrelic) {
    const nr = (window as any).newrelic;
    const pageUrl = path || window.location.pathname;
    
    // Track page view
    nr.setPageViewName(pageUrl);
    
    // Log in development for debugging
    if (process.env.NODE_ENV === 'development') {
      console.log('Page View:', pageUrl);
    }
  }
}

/**
 * Track time spent on page when the user navigates away
 */
export function trackTimeOnPage(): (() => void) {
  const startTime = Date.now();
  const path = typeof window !== 'undefined' ? window.location.pathname : '';
  
  return () => {
    if (typeof window !== 'undefined' && (window as any).newrelic) {
      const endTime = Date.now();
      const timeSpentMs = endTime - startTime;
      const timeSpentSeconds = Math.floor(timeSpentMs / 1000);
      
      trackEvent({
        category: 'Page',
        action: 'TimeSpent',
        label: path,
        value: timeSpentSeconds,
      });
    }
  };
}

/**
 * Track button click
 */
export function trackButtonClick(buttonName: string, additionalAttributes?: EventAttributes): void {
  trackEvent({
    category: 'Button',
    action: 'Click',
    label: buttonName,
    attributes: additionalAttributes,
  });
}

/**
 * Track form submission
 */
export function trackFormSubmission(formName: string, additionalAttributes?: EventAttributes): void {
  trackEvent({
    category: 'Form',
    action: 'Submit',
    label: formName,
    attributes: additionalAttributes,
  });
}

/**
 * Track donation action
 */
export function trackDonation(
  type: string,
  amount: number,
  currency: string,
  additionalAttributes?: EventAttributes
): void {
  trackEvent({
    category: 'Donation',
    action: type,
    value: amount,
    attributes: {
      currency,
      ...additionalAttributes,
    },
  });
}

/**
 * Add New Relic browser monitoring script to head
 * Call this function once when the application loads
 */
export function initNewRelicBrowserAgent(accountId: string, licenseKey: string, applicationId: string): void {
  if (typeof window !== 'undefined' && !document.getElementById('newrelic-browser-agent')) {
    const script = document.createElement('script');
    script.id = 'newrelic-browser-agent';
    script.type = 'text/javascript';
    script.async = true;
    
    // New Relic Browser Agent snippet
    script.innerHTML = `
      ;window.NREUM||(NREUM={});NREUM.init={privacy:{cookies_enabled:true}};
      window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(25),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,c){try{p?p-=1:o(c||new UncaughtException(t,e,n),!0)}catch(f){try{i("ierr",[f,s.now(),!0])}catch(d){}}return"function"==typeof u&&u.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t,e){var n=e?null:s.now();i("err",[t,n])}var i=t("handle"),a=t(26),c=t("ee"),s=t("loader"),f=t("gos"),u=window.onerror,d=!1,l="nr@seenError",p=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(h){"stack"in h&&(t(13),t(12),"addEventListener"in window&&t(6),s.xhrWrappable&&t(14),d=!0)}c.on("fn-start",function(t,e,n){d&&(p+=1)}),c.on("fn-err",function(t,e,n){d&&!n[l]&&(f(n,l,function(){return!0}),this.thrown=!0,o(n))}),c.on("fn-end",function(){d&&!this.thrown&&p>0&&(p-=1)}),c.on("internal-error",function(t){i("ierr",[t,s.now(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(){M++,N=y.hash,this[u]=g.now()}function o(){M--,y.hash!==N&&i(0,!0);var t=g.now();this[h]=~~this[h]+t-this[u],this[d]=t}function i(t,e){E.emit("newURL",[""+y,e])}function a(t,e){t.on(e,function(){this[e]=g.now()})}var c="-start",s="-end",f="-body",u="fn"+c,d="fn"+s,l="cb"+c,p="cb"+s,h="jsTime",m="fetch",v="addEventListener",w=window,y=w.location,g=t("loader");if(w[v]&&g.xhrWrappable){var b=t(10),x=t(11),E=t(8),O=t(6),P=t(13),R=t(7),T=t(14),L=t(9),j=t("ee"),S=j.get("tracer");t(16),g.features.spa=!0;var N,M=0;j.on(u,r),j.on(l,r),j.on(d,o),j.on(p,o),j.buffer([u,d,"xhr-done","xhr-resolved"]),O.buffer([u]),P.buffer(["setTimeout"+s,"clearTimeout"+c,u]),T.buffer([u,"new-xhr","send-xhr"+c]),R.buffer([m+c,m+"-done",m+f+c,m+f+s]),E.buffer(["newURL"]),b.buffer([u]),x.buffer(["propagate",l,p,"executor-err","resolve"+c]),S.buffer([u,"no-"+u]),L.buffer(["new-jsonp","cb-start","jsonp-error","jsonp-end"]),a(T,"send-xhr"+c),a(j,"xhr-resolved"),a(j,"xhr-done"),a(R,m+c),a(R,m+"-done"),a(L,"new-jsonp"),a(L,"jsonp-end"),a(L,"cb-start"),E.on("pushState-end",i),E.on("replaceState-end",i),w[v]("hashchange",i,!0),w[v]("load",i,!0),w[v]("popstate",function(){i(0,M>1)},!0)}},{}],5:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(13),c=t(12),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",l="resource",p="-start",h="-end",m="fn"+p,v="fn"+h,w="bstTimer",y="pushState",g=t("loader");g.features.stn=!0,t(8);var b=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof b&&(this.bstStart=g.now())}),o.on(v,function(t,e){var n=t[0];n instanceof b&&i("bst",[n,e,this.bstStart,g.now()])}),a.on(m,function(t,e,n){this.bstStart=g.now(),this.bstType=n}),a.on(v,function(t,e){i(w,[e,this.bstStart,g.now(),this.bstType])}),c.on(m,function(){this.bstStart=g.now()}),c.on(v,function(t,e){i(w,[e,this.bstStart,g.now(),"requestAnimationFrame"])}),o.on(y+p,function(t){this.time=g.now(),this.startPath=location.pathname+location.hash}),o.on(y+h,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],6:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(28)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],7:[function(t,e,n){function r(t,e,n){var r=t[e];"function"==typeof r&&(t[e]=function(){var t=r.apply(this,arguments);return o.emit(n+"start",arguments,t),t.then(function(e){return o.emit(n+"end",[null,e],t),e},function(e){throw o.emit(n+"end",[e],t),e})})}var o=t("ee").get("fetch"),i=t(25);e.exports=o;var a=window,c="fetch-",s=c+"body-",f=["arrayBuffer","blob","json","text","formData"],u=a.Request,d=a.Response,l=a.fetch,p="prototype";u&&d&&l&&(i(f,function(t,e){r(u[p],e,s),r(d[p],e,s)}),r(a,"fetch",c),o.on(c+"end",function(t,e){var n=this;if(e){var r=e.headers.get("content-length");null!==r&&(n.rxSize=r),o.emit(c+"done",[null,e],n)}else o.emit(c+"done",[t],n)}))},{}],8:[function(t,e,n){var r=t("ee").get("history"),o=t(28)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],9:[function(t,e,n){function r(t){function e(){s.emit("jsonp-end",[],l),t.removeEventListener("load",e,!1),t.removeEventListener("error",n,!1)}function n(){s.emit("jsonp-error",[],l),s.emit("jsonp-end",[],l),t.removeEventListener("load",e,!1),t.removeEventListener("error",n,!1)}var r=t&&"string"==typeof t.nodeName&&"script"===t.nodeName.toLowerCase();if(r){var o="function"==typeof t.addEventListener;if(o){var a=i(t.src);if(a){var u=c(a),d="function"==typeof u.parent[u.key];if(d){var l={};f.inPlace(u.parent,[u.key],"cb-",l),t.addEventListener("load",e,!1),t.addEventListener("error",n,!1),s.emit("new-jsonp",[t.src],l)}}}}}function o(){return"addEventListener"in window}function i(t){var e=t.match(u);return e?e[1]:null}function a(t,e){var n=t.match(l),r=n[1],o=n[3];return o?a(o,e[r]):e[r]}function c(t){var e=t.match(d);return e&&e.length>=3?{key:e[2],parent:a(e[1],window)}:{key:t,parent:window}}var s=t("ee").get("jsonp"),f=t(28)(s);if(e.exports=s,o()){var u=/[?&](?:callback|cb)=([^&#]+)/,d=/(.*)\.([^.]+)/,l=/^(\w+)(\.|$)(.*)$/,p=["appendChild","insertBefore","replaceChild"];Node&&Node.prototype&&Node.prototype.appendChild?f.inPlace(Node.prototype,p,"dom-"):(f.inPlace(HTMLElement.prototype,p,"dom-"),f.inPlace(HTMLHeadElement.prototype,p,"dom-"),f.inPlace(HTMLBodyElement.prototype,p,"dom-")),s.on("dom-start",function(t){r(t[0])})}},{}],10:[function(t,e,n){var r=t("ee").get("mutation"),o=t(28)(r),i=NREUM.o.MO;e.exports=r,i&&(window.MutationObserver=function(t){return this instanceof i?new i(o(t,"fn-")):i.apply(this,arguments)},MutationObserver.prototype=i.prototype)},{}],11:[function(t,e,n){function r(t){var e=a.context(),n=c(t,"executor-",e),r=new f(n);return a.context(r).getCtx=function(){return e},a.emit("new-promise",[r,e],e),r}function o(t,e){return e}var i=t(28),a=t("ee").get("promise"),c=i(a),s=t(25),f=NREUM.o.PR;e.exports=a,f&&(window.Promise=r,["all","race"].forEach(function(t){var e=f[t];f[t]=function(n){function r(t){return function(){a.emit("propagate",[null,!o],i),o=o||!t}}var o=!1,i=c(t,"resolver-",this),s=this;try{this.resolved=!1,this.rejected=!1,this.pending=!0,i.run()}catch(f){i.bail(f)}try{e.call(this,function(){return s.resolve}.apply(this,arguments),function(){return s.reject}.apply(this,arguments))}catch(f){throw a.emit("internal-error",[f]),f}}}),["resolve","reject"].forEach(function(t){var e=f.prototype[t];f.prototype[t]=function(t){var n=this;try{this.resolved="resolve"==n?!0:n.resolved,this.rejected="reject"==n?!0:n.rejected,this.pending="resolve"!=n&&"reject"!=n&&n.pending}catch(r){a.emit("internal-error",[r])}return"resolve"==t&&a.emit("propagate",[!0,!1,n],n.ctx),("reject"==t||"resolve"==t)&&a.emit("propagate",[!1,!0,n],n.ctx);try{return o("propagate",[!1,!1,n],n.ctx),e.apply(this,arguments)}catch(r){throw a.emit("internal-error",[r]),r}}}),f.prototype.then=function(t,e,n){var r=this;try{r.resolved||r.rejected||(a.emit("propagate",[!0,!1,r],r.ctx))}catch(o){a.emit("internal-error",[o])}return e=o(e,"fn-",this),t=o(t,"fn-",this),e&&a.emit("propagate",[!1,!0,r],r.ctx),this.pending?n:void 0};var u=i(a);[r,f.prototype].forEach(function(t){s(t,{then:u("then"),catch:u("catch"),finally:u("finally")})})})},{}],12:[function(t,e,n){var r=t("ee").get("raf"),o=t(28)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],13:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration=isNaN(t[1])?0:+t[1],t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(28)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],14:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,y,"fn-",c)}function i(t){g.push(t),h&&(x?x.then(a):v?v(a):(E=-E,O.data=E))}function a(){for(var t=0;t<g.length;t++)r([],g[t]);g.length&&(g=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(6);var f=t("ee"),u=f.get("xhr"),d=t(28)(u),l=NREUM.o,p=l.XHR,h=l.MO,m=l.PR,v=l.SI,w="readystatechange",y=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],g=[];e.exports=u;var b=window.XMLHttpRequest=function(t){var e=new p(t);try{u.emit("new-xhr",[e],e),e.addEventListener(w,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(p,b),b.prototype=p.prototype,d.inPlace(b.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),h){var x=m&&m.resolve();if(!v&&!m){var E=1,O=document.createTextNode(E);new h(a).observe(O,{characterData:!0})}}else f.on("fn-end",function(t){t[0]&&t[0].type===w||a()})},{}],15:[function(t,e,n){function r(t){if(!c(t))return null;var e=window.NREUM;if(!e.loader_config)return null;var n=(e.loader_config.accountID||"").toString()||null,r=(e.loader_config.agentID||"").toString()||null,f=(e.loader_config.trustKey||"").toString()||null;if(!n||!r)return null;var h=p.generateSpanId(),m=p.generateTraceId(),v=Date.now(),w={spanId:h,traceId:m,timestamp:v};return(t.sameOrigin||s(t)&&l())&&(w.traceContextParentHeader=o(h,m),w.traceContextStateHeader=i(h,v,n,r,f)),(t.sameOrigin&&!u()||!t.sameOrigin&&s(t)&&d())&&(w.newrelicHeader=a(h,m,v,n,r,f)),w}function o(t,e){return"00-"+e+"-"+t+"-01"}function i(t,e,n,r,o){var i=0,a="",c=1,s="",f="";return o+"@nr="+i+"-"+c+"-"+n+"-"+r+"-"+t+"-"+a+"-"+s+"-"+f+"-"+e}function a(t,e,n,r,o,i){var a="btoa"in window&&"function"==typeof window.btoa;if(!a)return null;var c={v:[0,1],d:{ty:"Browser",ac:r,ap:o,id:t,tr:e,ti:n}};return i&&r!==i&&(c.d.tk=i),btoa(JSON.stringify(c))}function c(t){return f()&&s(t)}function s(t){var e=!1,n={};if("init"in NREUM&&"distributed_tracing"in NREUM.init&&(n=NREUM.init.distributed_tracing),t.sameOrigin)e=!0;else if(n.allowed_origins instanceof Array)for(var r=0;r<n.allowed_origins.length;r++){var o=h(n.allowed_origins[r]);if(t.hostname===o.hostname&&t.protocol===o.protocol&&t.port===o.port){e=!0;break}}return e}function f(){return"init"in NREUM&&"distributed_tracing"in NREUM.init&&!!NREUM.init.distributed_tracing.enabled}function u(){return"init"in NREUM&&"distributed_tracing"in NREUM.init&&!!NREUM.init.distributed_tracing.exclude_newrelic_header}function d(){return"init"in NREUM&&"distributed_tracing"in NREUM.init&&NREUM.init.distributed_tracing.cors_use_newrelic_header!==!1}function l(){return"init"in NREUM&&"distributed_tracing"in NREUM.init&&!!NREUM.init.distributed_tracing.cors_use_tracecontext_headers}var p=t(23),h=t(17);e.exports={generateTracePayload:r,shouldGenerateTrace:c}},{}],16:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<l;r++)t.removeEventListener(d[r],this.listener,!1);return e.protocol&&"data"===e.protocol?void g("Ajax/DataUrl/Excluded"):void(e.aborted||(n.duration=a.now()-this.startTime,this.loadCaptureCalled||4!==t.readyState?null==e.status&&(e.status=0):i(this,t),n.cbTime=this.cbTime,s("xhr",[e,n,this.startTime,this.endTime,"xhr"],this)))}}function o(t,e){var n=c(e),r=t.params;r.hostname=n.hostname,r.port=n.port,r.protocol=n.protocol,r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.parsedOrigin=n,t.sameOrigin=n.sameOrigin}function i(t,e){t.params.status=e.status;var n=v(e,t.lastSize);if(n&&(t.metrics.rxSize=n),t.sameOrigin){var r=e.getResponseHeader("X-NewRelic-App-Data");r&&(t.params.cat=r.split(", ").pop())}t.loadCaptureCalled=!0}var a=t("loader");if(a.xhrWrappable&&!a.disabled){var c=t(17),s=t("handle"),f=t(15).generateTracePayload,u=t("ee"),d=["load","error","abort","timeout"],l=d.length,p=t("id"),h=t(21),m=t(20),v=t(18),w=NREUM.o.REQ,y=window.XMLHttpRequest;a.features.xhr=!0,t(14),t(7),u.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,e.loadCaptureCalled=!1,e.params=this.params||{},e.metrics=this.metrics||{},t.addEventListener("load",function(n){i(e,t)},!1),h&&(h>34||h<10)||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),u.on("open-xhr-start",function(t){this.params={method:t[0]},o(this,t[1]),this.metrics={}}),u.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid);var n=f(this.parsedOrigin);if(n){var r=!1;n.newrelicHeader&&(e.setRequestHeader("newrelic",n.newrelicHeader),r=!0),n.traceContextParentHeader&&(e.setRequestHeader("traceparent",n.traceContextParentHeader),n.traceContextStateHeader&&e.setRequestHeader("tracestate",n.traceContextStateHeader),r=!0),r&&(this.dt=n)}}),u.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=m(r);i&&(n.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"!==t.type||o.loadCaptureCalled||(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}};for(var c=0;c<l;c++)e.addEventListener(d[c],this.listener,!1)}),u.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),u.on("xhr-load-added",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),u.on("xhr-load-removed",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),u.on("xhr-resolved",function(){this.endTime=a.now()}),u.on("addEventListener-end",function(t,e){e instanceof y&&"load"===t[0]&&u.emit("xhr-load-added",[t[1],t[2]],e)}),u.on("removeEventListener-end",function(t,e){e instanceof y&&"load"===t[0]&&u.emit("xhr-load-removed",[t[1],t[2]],e)}),u.on("fn-start",function(t,e,n){e instanceof y&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),u.on("fn-end",function(t,e){this.xhrCbStart&&u.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,e],e)}),u.on("fetch-before-start",function(t){function e(t,e){var n=!1;return e.newrelicHeader&&(t.set("newrelic",e.newrelicHeader),n=!0),e.traceContextParentHeader&&(t.set("traceparent",e.traceContextParentHeader),e.traceContextStateHeader&&t.set("tracestate",e.traceContextStateHeader),n=!0),n}var n,r=t[1]||{};n=r.headers?new Headers(r.headers):new Headers;var o=f(this.parsedOrigin);if(o){e(n,o),t[1]={...r,headers:n}}}),u.on("fetch-start",function(t,e){this.params={},this.metrics={},this.startTime=a.now(),this.dt=e,t.length>=1&&(this.target=t[0]),t.length>=2&&(this.opts=t[1]);var n,r=this.opts||{},i=this.target;if("string"==typeof i?n=i:"object"==typeof i&&i instanceof w?n=i.url:window.URL&&"object"==typeof i&&i instanceof URL&&(n=i.href),o(this,n),"data"!==this.params.protocol){var c=(""+(i&&i instanceof w&&i.method||r.method||"GET")).toUpperCase();this.params.method=c,this.txSize=m(r.body)||0}}),u.on("fetch-done",function(t,e){if(this.endTime=a.now(),this.params||(this.params={}),"data"===this.params.protocol)return void g("Ajax/DataUrl/Excluded");this.params.status=e?e.status:0;var n;"string"==typeof this.rxSize&&this.rxSize.length>0&&(n=+this.rxSize);var r={txSize:this.txSize,rxSize:n,duration:a.now()-this.startTime};s("xhr",[this.params,r,this.startTime,this.endTime,"fetch"],this)})}},{}],17:[function(t,e,n){var r={};e.exports=function(t){if(t in r)return r[t];var e=document.createElement("a"),n=window.location,o={};e.href=t,o.port=e.port;var i=e.href.split("://");!o.port&&i[1]&&(o.port=i[1].split("/")[0].split("@").pop().split(":")[1]),o.port&&"0"!==o.port||(o.port="https"===i[0]?"443":"80"),o.hostname=e.hostname||n.hostname,o.pathname=e.pathname,o.protocol=i[0],"/"!==o.pathname.charAt(0)&&(o.pathname="/"+o.pathname);var a=!e.protocol||":"===e.protocol||e.protocol===n.protocol,c=e.hostname===document.domain&&e.port===n.port;return o.sameOrigin=a&&(!e.hostname||c),"/"===o.pathname&&(r[t]=o),o}},{}],18:[function(t,e,n){function r(t,e){var n=t.responseType;return"json"===n&&null!==e?e:"arraybuffer"===n||"blob"===n||"json"===n?o(t.response):"text"===n||""===n||void 0===n?o(t.responseText):void 0}var o=t(20);e.exports=r},{}],19:[function(t,e,n){function r(){}function o(t,e,n,r){return function(){return u.recordSupportability("API/"+e+"/called"),i(t+e,[f.now()].concat(c(arguments)),n?null:this,r),n?void 0:this}}var i=t("handle"),a=t(28),c=t(29),s=t("ee").get("tracer"),f=t("loader"),u=t(22),d=NREUM;"undefined"==typeof window.newrelic&&(newrelic=d);var l=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],p="api-",h=p+"ixn-";a(l,function(t,e){d[e]=o(p,e,!0,"api")}),d.addPageAction=o(p,"addPageAction",!0),d.setCurrentRouteName=o(p,"routeName",!0),e.exports=newrelic,d.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(h+"tracer",[f.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return e.apply(this,arguments)}catch(t){throw s.emit("fn-err",[arguments,this,t],n),t}finally{s.emit("fn-end",[f.now()],n)}}}};a("actionText,setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){m[e]=o(h,e)}),newrelic.noticeError=function(t,e){"string"==typeof t&&(t=new Error(t)),u.recordSupportability("API/noticeError/called"),i("err",[t,f.now(),!1,e])}},{}],20:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],21:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],22:[function(t,e,n){function r(t,e){var n=[a,t,{name:t},e];return i("storeMetric",n,null,"api"),n}function o(t,e){var n=[c,t,{name:t},e];return i("storeEventMetrics",n,null,"api"),n}var i=t("handle"),a="sm",c="cm";e.exports={constants:{SUPPORTABILITY_METRIC:a,CUSTOM_METRIC:c},recordSupportability:r,recordCustom:o}},{}],23:[function(t,e,n){function r(){return c.exists&&performance.now?Math.round(performance.now()):(i=Math.max((new Date).getTime(),i))-a}function o(){return i}var i=(new Date).getTime(),a=i,c=t(30);e.exports=r,e.exports.offset=a,e.exports.getLastTimestamp=o},{}],24:[function(t,e,n){function r(t,e){var n=t.getEntries();n.forEach(function(t){"first-paint"===t.name?l("timing",["fp",Math.floor(t.startTime)]):"first-contentful-paint"===t.name&&l("timing",["fcp",Math.floor(t.startTime)])})}function o(t,e){var n=t.getEntries();if(n.length>0){var r=n[n.length-1];if(u&&u<r.startTime)return;l("lcp",[r])}}function i(t){t.getEntries().forEach(function(t){t.hadRecentInput||l("cls",[t])})}function a(t){if(t instanceof v&&!g){var e=Math.round(t.timeStamp),n={type:t.type};e<=p.now()?n.fid=p.now()-e:e>p.offset&&e<=Date.now()?(e-=p.offset,n.fid=p.now()-e):e=p.now(),g=!0,l("timing",["fi",e,n])}}function c(t){"hidden"===t&&(u=p.now(),l("pageHide",[u]))}if(!("init"in NREUM&&"page_view_timing"in NREUM.init&&"enabled"in NREUM.init.page_view_timing&&NREUM.init.page_view_timing.enabled===!1)){var s,f,u,d,l=t("handle"),p=t("loader"),h=t(27),m=t(26),v=NREUM.o.EV;if("PerformanceObserver"in window&&"function"==typeof window.PerformanceObserver){s=new PerformanceObserver(r);try{s.observe({entryTypes:["paint"]})}catch(w){}f=new PerformanceObserver(o);try{f.observe({entryTypes:["largest-contentful-paint"]})}catch(w){}d=new PerformanceObserver(i);try{d.observe({type:"layout-shift",buffered:!0})}catch(w){}}if("addEventListener"in document){var g=!1,y=["click","keydown","mousedown","pointerdown","touchstart"];y.forEach(function(t){document.addEventListener(t,a,m(!1))})}h(c)}},{}],25:[function(t,e,n){function r(t,e){if(!o)return!1;if(t!==o)return!1;if(!e)return!0;if(!i)return!1;for(var n=i.split("."),r=e.split("."),a=0;a<r.length;a++)if(r[a]!==n[a])return!1;return!0}var o=null,i=null,a=/Version\\/(\S+)\\s+Safari/;if(navigator.userAgent){var c=navigator.userAgent,s=c.match(a);s&&c.indexOf("Chrome")===-1&&c.indexOf("Chromium")===-1&&(o="Safari",i=s[1])}e.exports={agent:o,version:i,match:r}},{}],26:[function(t,e,n){function r(t){function e(){t(c&&document[c]?document[c]:document[i]?"hidden":"visible","pageVisibility")}if("addEventListener"in document&&o&&document.addEventListener(o,e,a(!1)),r.preload&&r.preload===!0&&r.preloadCount===!1&&preload(),r.preloadCount&&preloadMany(e),document[i]){var n;document.addEventListener(o,function t(){document.removeEventListener(o,t,!0),n||(n=!0,e())}),setTimeout(function(){n||(n=!0,e())},1e4)}}function o(t,e){r.preload?r.preloadCount?(r.preloadCount--,r.preloadCount||t()):t():(r.preloadCount=e,r.preload=!0,t())}function i(t){o(t,2)}function a(t){return void 0===t?!0:!!t}function c(t,e,n){var o="addEventListener";if(navigator.userAgent.indexOf("PhantomJS")>=0)return!0;try{return document[o]?document[o](t,e,n):void 0}catch(c){return!1}}function s(t){var e=t.match(/Firefox[\\s/](\\d+\\.\\d+)/);return e&&e.length>=2?+e[1]>=55:!1}function f(){var t=0;try{t=Math.max(0,opener.innerWidth||0)}catch(e){}return t}function u(){var t=0;try{t=Math.max(0,screen.width||0)}catch(e){}return t}function d(){var t=0;try{t=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0,document.body.clientWidth||0)}catch(e){}return t||u()||f()}function l(){var t=[];try{t=[screen.width||0,screen.height||0,screen.colorDepth||0]}catch(e){}return t}var p=document.hidden;e.exports=function(t,e){if("addEventListener"in document&&o&&document.addEventListener(o,function n(){document.removeEventListener(o,n,a(e)),t()},a(e)),r.load){var i=function(){var e=("hidden"===document.visibilityState||"prerender"===document.visibilityState)&&d()<2e3;e?setTimeout(i,1e3):t()};setTimeout(i,0)}},r.load=!1,r.preload=!1,r.preloadCount=!1;var h=window.MutationObserver||window.WebKitMutationObserver;if(document.addEventListener&&h){var m={attributes:!0,childList:!0,characterData:!0,subtree:!0},v=[];try{(new h(function(t){s(navigator.userAgent)||v.push(t);for(var e=0;e<v.length;e++)v[e].disconnect()})).observe(document.documentElement,m)}catch(w){}}var g="onpageshow"in window;g&&function(t){window.addEventListener("pageshow",function(e){e.persisted&&t()},a(!1))}(t),window.addEventListener("message",function(t){t&&"string"==typeof t.data&&t.data.indexOf("NRBA:")>=0&&setTimeout(function(){window.postMessage({NRBA:"HideRunner"},"*")},1)});var y,b="undefined"!=typeof CustomEvent||"function"==typeof Event;b&&(y=new(b?CustomEvent:Event)("NRBA:HideRunner")),document.addEventListener&&document.addEventListener("NRBA:HideRunner",function(){y&&document.dispatchEvent(y)});var x=[function(){return l()[0]<=320&&l()[1]<=400}];return void 0!==navigator.standalone&&function(t){var e=[/iPad/i,/iPhone/i,/iPod/i],n=/safari/i;e.some(function(t){return t.test(navigator.userAgent)})&&(n.test(navigator.userAgent)?navigator.standalone&&t():navigator.standalone||t())}(t),window.safari&&function(t){window.addEventListener("beforeunload",function(){setTimeout(t,0)});var e=!1;window.addEventListener("pageshow",function(){e=!0}),window.addEventListener("pagehide",function(){e&&(e=!1,setTimeout(t,0))})}(t),navigator.userAgent.match(/MSIE 10/)&&c("focus",function(){setTimeout(t,0)}),"complete"===document.readyState?t():c("load",function(){setTimeout(t,0)}),function(t){"matchMedia"in window&&window.matchMedia("print").addListener(function(e){e.matches||t()})}(t),c("online",t,{capture:!0}),c("pageshow",t,{capture:!0}),function(){for(var e=0;e<x.length;e++)if(x[e]())return t()}(),document.addEventListener("visibilitychange",t,{capture:!0}),o}(),o=document.visibilityState,i="visibilitychange";switch(o){case"visible":case"hidden":case"prerender":break;default:i="webkitvisibilitychange",p=document.webkitHidden}e.exports.registerIosPreRenderer=i},{}],27:[function(t,e,n){function r(t,e){var n=[a,t,{name:t},e];return i("storeMetric",n,null,"api"),n}var o,i=t("handle"),a="sm";(o=t("bd-metrics"))&&o.onDetectedEnd&&r("replicadetectiontime");e.exports=function(t){r("fn",t)}},{}],28:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=function(t,e){var n=[],o=[],i=[];return t.each(function(t,a,c,s){var f=[];"function"==typeof c?s=c(t,a):c&&(s=s,c=void 0);var u=f;try{if(a[0]===t)throw new Error("First argument fn cannot equal the receiver or we will have infinite loops");u=t.apply(c||this,r(a,1).concat(f[0]===s?[]:s))}catch(d){i.push(d);try{e&&e.emit("internal-error",[d])}catch(l){}}return o.push(u),u}),n.length?{qs:o,qQueue:n,errors:i}:o},Function.prototype.each=function(t,e){var n=this;return function(){var r=arguments[0];if(t.guarded&&!e)try{return n.apply(this,arguments)}catch(o){throw t.errors&&t.errors(o),o}return"function"==typeof r&&t.wrapped&&(arguments[0]=t(r)),n.apply(this,arguments)}}},{}],29:[function(t,e,n){e.exports=function(t){var e,n;return function(){e=arguments,n=this;try{return t.apply(this,arguments)}catch(r){throw r}}}},{}],30:[function(t,e,n){var r=t("ee").get("tracer"),o=t("loader"),i=!1;o.features.stn=!0,t(5),e.exports=r.exportPromiseChain=function(t){var e=r.exportFunctions(["promise-before","promise-after","promise-error"]);function n(t,n,r){i||(i=!0,o.pt(window.Promise));var a=this;if(t&&r&&"number"==typeof r.length&&0!==r.length){var c=this.then;if("function"==typeof c){c=e.promise_after(a,t,function(){var e=g("promise-after",this,arguments);return c.apply(this,arguments)},n);var s=this.catch;if("function"==typeof s){var f=function f(){var r=g("promise-error",this,arguments);return s.apply(this,arguments)};this.catch=e.promise_error(a,t,f,n)}this.then=c}return this}function g(t,n,a){return e[t](n,a,r)}return t?g.bind(null,"promise-before",null):n},r.exportHasFinally=function(){return!1},r.exportIsCascadingPromise=function(t){return!1}},{}],31:[function(t,e,n){e.exports=function(t){for(var e=t.concat({}),n={},r=0;r<e.length;r++){var o=e[r],i=o[0],a=o[1],c=o[2],s=o[3],f={};void 0!==n[i]?f=n[i]:n[i]=f,Object.keys(f).length&&JSON.stringify(f),n[i][a]=1}return n}},{}],32:[function(t,e,n){var r=t("ee").get("jsonp"),o=t(28)(r);if(e.exports=r,o.inPlace(XMLHttpRequest.prototype,["open","send"],"-xhr-",window.XMLHttpRequest),o.inPlace(window,["fetch"],"-fetch-",window),o.inPlace(window,["fetch"],"-node-fetch-",window),window.addEventListener){var i=/[?&](?:callback|cb)=([^&#]+)/,a=/(.*)\.([^.]+)/,c=/^(\w+)(\.|$)(.*)/;window.addEventListener("message",function(t){var e=A(t.data);if("string"==typeof e&&"function"==typeof window[e]){var n=-1===e.indexOf(".")?[e]:function(t){if(-1!==t.indexOf("."))for(var e,n=t.split("."),r=0,o=n.length;r<o;r++){if(e){if(!(e=e[n[r]]))break}else e=this}return e}(e)||function(t){if(-1===t.indexOf("."))return null;var e,n=t.match(a),r=null;if(n&&n.length>=3&&(e=window[n[1]],r=n[2]),e&&"function"==typeof e[r])return e[r]}(e)||function(t){if(-1===t.indexOf("."))return null;var e=null,n=t.match(c),r=window;if(n&&n.length>=4&&(e=r[n[1]],!e||!(e=e[n[3]])))return null;return e}(e);n&&r.emit("jsonp-end",[],n)}},!1)}}},{}],EBS:[function(t,e,n){var r=t("ee").get("error");e.exports=function(t){return"perf"in t?{errorServiceStart:t.perf.offset}:{}}},{}],bbc:[function(t,e,n){var r=t("ee"),o=r.create("bstTimer"),i=t("wrap-function");e.exports=o,i.inPlace(window,["setTimeout","setInterval","setImmediate"],"setTimer-"),o.on("setTimer-start",function(t){this.bstStart=Date.now()}),o.on("setTimer-end",function(t,e){var n=Date.now()-this.bstStart;n=this.timerDuration?this.timerDuration+n:n,this.bstType="setTimeout"===t[0]?2:"setImmediate"===t[0]?3:1,o.emit(t[0]+n,this.bstType,e)})},{}],bd:[function(t,e,n){var r=t("ee"),o=r.create("bd"),i=t("wrap-function");e.exports=o,i.inPlace({MutationObserver:["new","observe"],IntersectionObserver:["new","observe"],PerformanceObserver:["new","observe"]},"bd-"),o.on("bd-start",function(t){this.startTime=Date.now(),this.opts=t[2]}),o.on("bd-end",function(t,e){var n=Date.now()-this.startTime,r=this.opts.detail;this.observedAt=r&&r.time||Date.now(),o.emit(t[0]+"-end",[n,this.opts,this.observedAt],e)})},{}],"bd-metrics":[function(t,e,n){var r=0,o="0123456789ABCDEF".split(""),i="0123456789abcdef".split(""),a="01234567".split(""),c=t("ee"),s=c.create("bd-metrics"),f=t(31),u="dom-prefixes font-face selectors generated-content conditional-rules transforms transitions animations border-image border-radius box-shadow text-shadow background-size",d=u.split(" "),l=s,p=window.devicePixelRatio||1,h=Math.max(screen.width||0,screen.height||0)*p,m=navigator.userAgent,v=null,w=!1,y=null,g=Date.now(),b=t(26);function R(){v||(v={}),x("target-ms-time",Date.now()-g),b(V)}function V(){x("transfer-size",function(){try{var t=performance.getEntriesByType("navigation")[0];if(t&&t.transferSize)return t.transferSize}catch(e){}return 0}());var t,e,n=!1;try{if("visibilityState"in document&&(document.hidden||document.visibilityState&&"visible"!==document.visibilityState)||"pageshow"in window&&("complete"!==document.readyState||"pageshow"in window&&window.performance.getEntriesByType&&window.performance.getEntriesByType("navigation").length>0&&2===window.performance.getEntriesByType("navigation")[0].type))return;n=!0}catch(r){n=!1}if(n&&(v.onDetectedEnd))if(w&&y)try{v.onDetectedEnd(y)}catch(r){}else try{v.onDetectedEnd(null)}catch(r){}}b.preload=!0,function t(){r++,setTimeout(function(){r<10&&t()},1)}(),v=function(){var t={};try{var e=function(){var t=document.createElement("div");t.style.cssText="flex:1";try{return!!t.style.flex}catch(e){return!1}}(),n=getComputedStyle(document.documentElement),r={};if(d.forEach(function(t){if(t in v)return r[t]=v[t];"font-face"===t?r[t]=n["font-family"]?!0:!1:"generated-content"===t?r[t]=n.content&&"none"!==n.content?!0:!1:r[t]=!1}),h>=1080&&(r.hd=!0),/ipad|ipod|iphone|android|blackberry|webos|windows phone|windows(?=.*touch)/i.test(m)&&(r.mobile=!0),/ipad|ipod|iphone|android/i.test(m)&&(r.touch=!0),/msie ([0-9]{1,}[.0-9]{0,})/i.test(m)&&(r.ie=!1),e&&(r.flexbox=!0),/AppleWebKit/i.test(m)&&(r.safari=!0),/chrome/i.test(m)&&!/edge/i.test(m)&&(r.chrome=!0),/HeyTapBrowser/i.test(m)&&(r.heytap=!0),/OPR/i.test(m)&&(r.opera=!0),/Firefox/i.test(m)&&(r.firefox=!0),/Edge/i.test(m)&&(r.edge=!0),/FBIOS/i.test(m)&&(r.fb=!0),/CriOS/i.test(m)&&(r.fb=!0),/(WebView|Version|.*; wv|(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari))/i.test(m)&&/Android|iPhone|iPad|iPod/i.test(m)&&(r.webview=!0),performance.now&&Math.floor(performance.now())===performance.now()&&(r.intlPerfNow=!0),Object.prototype.hasOwnProperty.call(window,"PerformanceObserver")&&"function"==typeof window.PerformanceObserver&&(r.perfObs=!0),"undefined"!=typeof Intl&&(r.intl=!0),window.Promise&&(r.promise=!0),window.console&&console.log&&(r.console=!0),"undefined"!=typeof Symbol&&(r.symbol=!0),/PhantomJS/.test(m)&&(r.phantomjs=!0),window.performance&&"function"==typeof window.performance.mark&&"function"==typeof window.performance.clearMarks&&(r.perfMark=!0),window.requestAnimationFrame&&(r.raf=!0),window.devicePixelRatio&&(r.dpr=Math.round(100*window.devicePixelRatio)/100),/Mobile/.test(m)&&(r.mobile=!0),window.localStorage&&(r.localStorage=!0),window.XMLHttpRequest&&(r.xhr=!0),window.MutationObserver&&(r.mutationObs=!0),r.win=function(){try{return!!window.frameElement}catch(t){return!0}}(),r.geo=navigator.geolocation,r.clipboard=!!navigator.clipboard,r.screen={width:screen.width,height:screen.height},screen.orientation&&(r.orientation=screen.orientation.type),"connection"in navigator){var o=navigator.connection;r.connection={downlink:o.downlink,downlinkMax:o.downlinkMax,effectiveType:o.effectiveType,rtt:o.rtt,saveData:o.saveData,type:o.type}}if(r.memory=!(!window.performance||!window.performance.memory)&&Math.round(100*window.performance.memory.totalJSHeapSize/1048576)/100,window.matchMedia){var i=window.matchMedia("(prefers-color-scheme: dark)"),a=i.media;r.prefersColorScheme={media:a,matches:i.matches,dark:i.matches}}t=r}catch(c){}return t}(),x("platform",B()),s.on("bd-start",function(t,e,n){l=this,w=!0,y=n;try{n.time=Date.now()}catch(r){}}),function(){if(window.performance&&window.performance.timing&&window.performance.getEntriesByType&&window.addEventListener){r&&!0,addEventListener("pageshow",function(t){t&&"back_forward"===t.persisted}),v&&x("features",v),x("agent",m),x("screen",JSON.stringify({h:screen.height,w:screen.width})),window.Promise&&window.Promise.toString().indexOf("native")>=0&&x("es-promise",!0),"function"==typeof Map&&x("es-map",!0);try{document.querySelectorAll&&document.querySelectorAll(":scope body")&&x("scope-qsa",!0)}catch(t){}var t={},e={};try{var n=new RegExp("\\\\p{L}","yu");t.l=n.exec("\\u0061")?"0":"1",n=new RegExp("\\\\p{N}","yu"),t.n=n.exec("1")?"0":"1",n=new RegExp("\\\\p{Sc}","yu"),t.sc=n.exec("$")?"0":"1",n=new RegExp("\\\\p{P}","yu"),t.p=n.exec(".")?"0":"1",n=new RegExp("\\\\p{Lu}","yu"),t.lu=n.exec("A")?"0":"1",n=new RegExp("\\\\p{Ll}","yu"),t.ll=n.exec("a")?"0":"1",n=new RegExp("\\\\p{ASCII_Hex_Digit}","yu"),t.ahd=n.exec("A")?"0":"1",n=new RegExp("\\\\p{Emoji}","yu"),t.e=n.exec("😀")?"0":"1",n=new RegExp("\\\\p{Extended_Pictographic}","yu"),t.ep=n.exec("😀")?"0":"1",n=new RegExp("\\\\p{Hex_Digit}","yu"),t.hd=n.exec("A")?"0":"1",n=new RegExp("[[\\u0061-\\u0066]]","u"),e.l=n.exec("a")?"0":"1",n=new RegExp("[[\\u0061-\\u007A]--[\\u0064-\\u0066]]","u"),e.l2=n.exec("a")?"0":"1",n=new RegExp("[[^\\u0064-\\u0066]]","u"),e.ln=n.exec("a")?"0":"1",n=new RegExp("[\\u0061-\\u0063]","u"),e.rr=n.exec("a")?"0":"1",n=new RegExp("\\ud83d\\ude00","u"),e.e=n.exec("😀")?"0":"1",x("unicoder",JSON.stringify({p:t,b:e}))}catch(u){}window.requestIdleCallback&&s.emit("bd-onDetectedEnd",null),v&&"OPR"in window&&"string"==typeof OPR.addons&&x("is-opera",!0);try{var r=window.top!==window&&!!window.top&&!!window.top.location.href;x("is-framed",r?"1":"0")}catch(d){try{x("is-framed","2")}catch(u){}}}}(),s.onDetectedEnd=function(t){v&&(v.onDetectedEnd=!0,l.emit("bd-onDetectedEnd",t))},e.exports=s;var k=document.createElement("a"),A=window.URL&&window.URL.prototype&&"function"==typeof window.URL.prototype.toString,S=null;A||(S={});var O=null;s.replicadetectiontime=function(){return Date.now()-g},e.exports.createMarkerPayload=function(t,e,n,r){null==n&&(n=0);var o={queueTime:0,browserInteractionId:r},i=t&&t.trigger_source_st;return i&&(o.queueTime=Date.now()-i),e&&(o.interactionId=e),o};var P={};function B(){try{var t,e=navigator.userAgent,n="";if((t=e.match(/Edge\/([\d]+)/))&&t.length>=2&&(n="Edge "+t[1]),!n&&(t=e.match(/Firefox\/([\d]+)/))&&t.length>=2&&(n="Firefox "+t[1]),!n){var r=e.indexOf("Android "),o=r>=0?e.indexOf(" ",r):-1;if(o>=0){o=e.indexOf(" ",o+1);var i=o>=0?e.substring(r,o):e.substring(r);if(i&&(n=i,e.indexOf("Mobile")>=0)){var a=e.indexOf("Chrome/");if(a>=0){var c=e.indexOf(" ",a);n=c>=0?n+" "+e.substring(a,c):n+" "+e.substring(a)}}}else{var s=e.match(/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i);if(s&&s.length>0&&(n="iOS Webview"),!n&&(s=e.match(/Trident.*rv[ :]*([\d.]+)/))&&s.length>0&&(n="IE "+s[1]),!n&&(s=e.match(/CriOS\/([\d]+)/))&&s.length>0&&(n="Chrome ios "+s[1]),!n){var f=e.indexOf(" OPR/");if(f>=0){var u=e.substring(f+5);s=u.match(/[\d.]+/),n="Opera "+(s&&s.length>0?s[0]:u)}var d=e.indexOf(" Edg/");if(!n&&d>=0){var l=e.substring(d+5);s=l.match(/[\d.]+/),n="Edge "+(s&&s.length>0?s[0]:l)}if(!n){var p=e.indexOf("Chrome/");if(p>=0){var h=e.indexOf(" ",p);n=h>=0?"Chrome "+e.substring(p+7,h):"Chrome "+e.substring(p+7)}else{var m=e.indexOf("Safari/");if(m>=0){var v=e.indexOf("Version/");n=v>=0?"Safari "+e.substring(v+8):e.substring(m+7)}}}}}return n}catch(w){}}function L(t,e){if(e&&t!==e.href){try{e.href=t}catch(n){}return e.href}}function M(t){if(t){for(var e=[],n=0;n<Math.min(16,t.length);n++)e.push(i[t.charCodeAt(n)&15]);return e.join("")}}function x(t,e){if(t in P&&null!==e&&P[t]===e)return!1;try{null===e?delete P[t]:P[t]=e,s.emit("bd-metrics",[t,e])}catch(n){}return!0}function C(){return 0===Math.floor(4096*Math.random()+1)}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?u(t,c,a):a()}function n(n,r,o,i,a){if(a!==!1&&(a=!0),!l.aborted||i){t&&a&&t(n,r,o);for(var c=e(o),u=m(n),d=u.length,f=0;f<d;f++)u[f].apply(c,r);var p=s[y[n]];return p&&p.push([g,n,r,c]),c}}function d(t,e){b[t]=m(t).concat(e)}function m(t){return b[t]||[]}function v(t){return f[t]=f[t]||o(n)}function w(t,e){if(t){var n=t.newrelicHeader,r=t.traceContextParentHeader,o=!1,i=!1;if(n&&(o=!0),r&&(i=!0),!o&&!i)return t.sameOrigin?f.ajax:f.dtrum;return p?p.newrelic?f.newrelic:p.ajax?f.ajax:p.dtrumAgent?f.dtrum:f.ajax:o?f.newrelic:i?f.dtrum:f.ajax}}var y={},g={},b={},x={},E=Object.keys||function(t){var e=[];for(var n in t)e.push(n);return e},O="nr@context",P=t("gos");if(i()&&a()){var R={};"addEventListener"in window.performance&&(window.performance.addEventListener("webkitresourcetimingbufferfull",function(){R.webkitrqstcomplete=!0,l.aborted&&(R.nrrqstabort=!0),g.jserrs&&g.jserrs.length>0&&(R.jserrs=g.jserrs.length)},!1),window.performance.addEventListener("resourcetimingbufferfull",function(){R.rqstcomplete=!0,l.aborted&&(R.nrrqstabort=!0),g.jserrs&&g.jserrs.length>0&&(R.jserrs=g.jserrs.length)},!1)),"getEntriesByType"in window.performance&&(R.inapp=1),f.dtrum=v("dtrum"),f.ajax=v("ajax"),f.newrelic=v("newrelic");var T=document.currentScript,L=T?T.src:void 0,j="";if(L){var S=L.match(/^[\\/]+([^\\/]+)/);j=S&&S.length>=2?S[1]:"",p=function(){var t=L.match(/(http|https|file):[\\/]+([^:\\/]*)/);if(!t)return{};var e=t[1],n=t[2];n.indexOf("ineu")>=0?n="ineu":n.indexOf("inap")>=0?n="inap":n.indexOf("inml")>=0?n="inml":n.indexOf("inau")>=0?n="inau":n.indexOf("inar")>=0&&(n="inar");var r={protocol:e,host:n};return"newrelic"!=j&&"nr"!=j||(r.newrelic=!0),r}()}var M=new Error;f.jserrors={push:function(t){g.jserrs||(g.jserrs=[]),g.jserrs.push(t)}},f.jserrors.ignoreWindowError=function(t){M.message=t,this.push(M),M.message=void 0};var N=null;l._A&&l._A.errorObject&&(N=l._A.errorObject,l._A.errorObject=void 0),N&&f.jserrors.push(N),f.events=v("events"),b[x.events]=E(h);for(var k=[],A=0;A<k.length;A++)k[A]();var C=v("handle");e.exports=l;var I=l.ee=new r;I.get=function(t){var e=typeof t,n;if(!t)return new r;if("string"===e)return"events"===t?l.ee.get("events"):!b[t]&&(n=new r,b[t]=n,v(t)),b[t];throw new Error("uhoh")},I.on=function(t,e){return"object"==typeof t?void function(t,e){for(var n in t)b[t[n]]=e}(t,e):void d(t,e)},I.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,d(t,n),this},I.off=function(t,e){if(0===arguments.length)return b={},this;if(1===arguments.length)return b[t]=[],this;if(void 0===e)return b[t]=[];e.fn&&(b[t]=m(t).filter(function(t){return t!==e.fn}));for(var n=b[t],r=0;r<n.length;r++)n[r]===e&&n.splice(r,1);return this},I.emit=function(e,r,o){if(!b[e])return new r;for(var i=b[e].slice(0),a=0;a<i.length;a++)i[a].apply(o||l.ee,r instanceof Array?r:t.call(arguments,1));return this.fired=!0,this};var H={"*":"*"};I.buffer=function(e,n){var r;return n=n||H,function(e,n){if(e instanceof Array)for(var r=0;r<e.length;r++)n(e[r])}(e instanceof Array?e:[e],function(e){var r=n["*"];g[e]=g[e]||[],r&&(g[e]=g[e].concat(r)),n[e]&&(g[e]=g[e].concat(n[e]))}),function(e,n,r){if(!g[e])return!0;r=r||{};for(var o=g[e],i=0;i<o.length;i++)o[i](n,r);return!0}}}function i(){return"init"in NREUM&&"distributed_tracing"in NREUM.init&&!!NREUM.init.distributed_tracing.enabled}function a(){return"init"in NREUM&&"privacy"in NREUM.init&&(!!NREUM.init.privacy.cookies_enabled||!!NREUM.init.privacy.cookiePrivacySettings)}var c=t(23),s={},f={},u=t(19);e.exports=u();var d=t("gos"),l={},p=null,h="req res err xhr load bst pushState pageshow popstate visibilitychange fetch readystatechange setImmediate",m=!1;try{m=0===t(21)}catch(v){}m&&(d&&d("err",function(t,e,n,r,o){try{o||(o={}),o.time=e&&e.timeStamp?Math.floor(e.timeStamp):l._A?(l._A.stt||(l._A.stt=performance.timeOrigin),l._A.stt+performance.now()):Date.now(),e&&e.type&&(o.type=e.type),n&&o.time-n.time<3e4&&n.time>0&&(o.prevtime=n.time),void 0!==r&&(o.prevtype=r.type),l.ee.emit("internal-error",[o])}catch(i){}}).on("internal-error",function(t){try{var e=t[0].timestamp||t[0].time;l.stt||(l.stt=performance.timeOrigin),e&&0!==e&&(l.total=e-(l.stt||0)+performance.now()),l.err_cb=t[0],l.err_time=e}catch(n){}}),l.emitInternalError=function(t,e,n){try{void 0===n&&(n={}),l.ee&&l.ee.emit&&l.ee.emit("internal-error",[{type:t,error:e,time:Date.now()}])}catch(r){}}),window.addEventListener("unhandledrejection",function(t){try{var e=t.reason;if(!e&&t.detail&&t.detail.reason&&(e=t.detail.reason),e){var n={};n.time=performance.timeOrigin+performance.now(),n.target_link="unhandled-promise-rejection",n.message=e.message||e,n.error=e,n.stack=e.stack,l.ee.emit("internal-error",[n])}}catch(r){}})},{}],handle:[function(t,e,n){e.exports=function(t,e,n,r){return function(){return this[n].apply(this,arguments)}}},{}],id:[function(t,e,n){var r=1,o="nr@id",i=t("gos");e.exports=function(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:i(t,o,function(){return r++})}},{}],loader:[function(t,e,n){function r(){if(!A++){var t=y.info=NREUM.info,e=h.getElementsByTagName("script")[0];if(setTimeout(f.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return f.abort();s(b,function(e,n){t[e]||(t[e]=n)});var n=a();c("mark",["onload",n+y.offset],null,"api"),c("timing",["load",n]);var r=h.createElement("script");r.src="https://"+t.agent,e.parentNode.insertBefore(r,e)}}function o(){"complete"===h.readyState&&i()}function i(){c("mark",["domContent",a()+y.offset],null,"api")}function a(){return g.exists&&performance.now?Math.round(performance.now()):(m=Math.max((new Date).getTime(),m))-y.offset}var c=t("handle"),s=t(25),f=t("ee"),u=t(18),d=t(19),l=NREUM.o,p=window.onload,h=l.document,m=(new Date).getTime(),v=t(2),w=l.XMLHttpRequest,y={},g=t(30),b={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-spa-1184.min.js"},x=w&&w.prototype&&w.prototype.addEventListener&&!/CriOS/.test(navigator.userAgent),E=this.io=this.io||{},O=null,P=n.exports={offset:m,now:a,origin:b,features:{},xhrWrappable:x,userAgent:v,disabled:!1};!function(){try{if(g.exists&&!g.disabled){var t,e,n,r;if((t=g.offset-g.now())>=0&&t<.5&&(g.offset=g.now()+t),e=!0,"onpagehide"in l&&l.performance&&l.performance.memory&&!u.mobile&&"undefined"!=typeof document&&"undefined"!=typeof window&&window.customElements&&document.createElement("img")instanceof HTMLImageElement)try{var o=l.innerHeight||document.documentElement.clientHeight;n={mobile:o<500},n.mobile&&NREUM.info&&NREUM.info.errorBeacon&&(NREUM.info.errorBeacon="staging-","https:"===document.location.protocol?"-secure":"")+NREUM.info.errorBeacon)}catch(i){}if(P.maxBytes=1e7,e&&(P.ignore={},P.ignore.rejections=!0,P.ignore.rejectedPromises=!0,P.errorSampleRate=.01,P.disabled=!1,P.proxy={assets:"/nrjs/assets"},P.broken=n,P.stn=2,P.xhrWrappable=!x||!0,P.useFeatures=function(t){if(!P.disabled){var e=!0;return i(t,function(t){e=e&&P.features[t]}),e&&x}return!1},P.features.xhr=!0,P.features.fetch=!0,P.features.promise=d(!1),P.features.stn=!0,P.features.ins=!0,P.features.spa=!0,P.features.err=!0,!t)){try{!function(t,e){var n=!1,r=t("ee"),o=t("wrap-function");function i(t){!1===n&&P.features[t]&&(n=!0,r.buffer([t],{events:t,target:P}))}i("err"),i("xhr"),i("fetch"),o.inPlace(console,["warn"],"nrWrapper-"),r.on("nrWrapper-start",function(t){t[0]&&"string"==typeof t[0]&&"Telemtry rate limiting engaged"===t[0].substring(0,33)&&(P.skip=P.skip||{},P.skip[t[0]]=!0)})}(t,0)}catch(a){f.emit("internal-error",[a])}try{r={}}catch(a){}}g.disabled&&(P.disabled=!0)}}(),t(24);var R=null;function T(){R?clearTimeout(R):d&&f.on("fn-end",function(t){this.xhrCbStart&&f.emit("xhr-cb-time",[Date.now()-this.xhrCbStart,this.onload,t],t)}),d=!1,R=setTimeout(function(){d=!0,f.on("fn-end",function(t){this.xhrCbStart&&f.emit("xhr-cb-time",[Date.now()-this.xhrCbStart,this.onload,t],t)})},50)}O=function(){var t=NREUM.info,e=t.licenseKey,n=t.applicationID;O=3};var A=0;function S(){try{P.stats=t(31)([["network",[{t:2,s:0,d:g.exists&&performance.timing.navigationStart?Math.round(g.now()-performance.timing.navigationStart):void 0}]]])}catch(e){}}function j(){try{var t=!((top?top:window).performance&&(top?top:window).performance.timing)||top&&top===window||t&&"function"==typeof t.toString&&t.toString().indexOf("location=")!=-1;if(t||(P.stn=1),"complete"===document.readyState&&(S(),p?p():document.addEventListener&&document.addEventListener("load",S,!1)),(g.exists&&!g.disabled||!P.disabled)&&"addEventListener"in document&&!u.mobile){var e,n=["click","keydown","mousedown","pointerdown","touchstart"],o=!u.mobile||P.mobile;if(o)for(e=0;e<n.length;e++)document.addEventListener(n[e],T,!1)}}catch(t){}}v&&navigator.serviceWorker&&T(),j(),"complete"===document.readyState?o():window.addEventListener("load",o),window.addEventListener("pageshow",o),window.addEventListener?window.addEventListener("pagehide",function(){try{setTimeout(function(){y.aborted||r()},25)}catch(t){}}):window.attachEvent("onunload",function(){y.aborted||r()})},{}]}},{},[32,2,1,5,4]);
      ;NREUM.init={privacy:{cookies_enabled:${licenseKey && licenseKey.length > 0}},ajax:{deny_list:["bam.nr-data.net"]}};
      window.NREUM||(NREUM={});NREUM.info={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",licenseKey:"${licenseKey}",applicationID:"${applicationId}",sa:1}
    `;
    
    document.head.appendChild(script);
  }
}

// Initialize analytics on page load if window.newrelic is available
export function initAnalytics(): void {
  // Listen for page navigation events
  if (typeof window !== 'undefined') {
    // Track initial page view
    trackPageView();
    
    // Get New Relic license key and account ID from environment variables
    const licenseKey = import.meta.env.VITE_NEW_RELIC_BROWSER_LICENSE_KEY;
    const accountId = import.meta.env.VITE_NEW_RELIC_ACCOUNT_ID;
    const applicationId = import.meta.env.VITE_NEW_RELIC_APPLICATION_ID;
    
    // Initialize New Relic if credentials are available
    if (licenseKey && accountId && applicationId) {
      initNewRelicBrowserAgent(accountId, licenseKey, applicationId);
    }
  }
}